\documentclass[12pt,notitlepage]{article}

%\usepackage{listings}
\usepackage[utf8]{inputenc}%jsta
\usepackage[english]{babel}%test
\usepackage{float}

\usepackage{natbib}
\usepackage[obeyspaces,spaces]{url}
\bibliographystyle{plainnat}
\bibpunct[; ]{(}{)}{,}{a}{}{;}

\usepackage{pifont,mdframed}%test

\usepackage{geometry}
\geometry{left=1.25in,right=1.25in,top=1.25in,bottom=1.25in}
\usepackage{rotating}
\usepackage{fancyhdr}
\usepackage[bookmarks,colorlinks,breaklinks,citecolor=red]{hyperref}
\usepackage{longtable}


%\usepackage{float}
\usepackage{graphicx,subfig}
% \usepackage{placeins}
\setlength\headheight{26pt}

\fancypagestyle{plain}{\fancyhf{}\fancyhead[R]{\includegraphics[width=6.0in,keepaspectratio=true]{sfwmd_bar8half_wordorexcel.png}}}

\author{Joseph Stachelek}
\title{dbhydroR: An R package to access the DBHYDRO Environmental Database}

%\VignetteIndexEntry{An R package to access the DBHYDRO Environmental Database}

\usepackage{Sweave}
\begin{document}
\input{dbhydroR-concordance}
\maketitle
%\tableofcontents
 


\section{Introduction}

This document introduces the \texttt{dbhydroR} package and its associated functions. These functions are aimed at improving programmatic workflows that query the DBHYDRO Environmental Database. HTTP requests are faciliated by the httr \citep{httr} and RCurl \citep{rcurl} packages. 

\section{Package installation}

The \texttt{R} package \texttt{dbhydroR} is distributed via a \texttt{.tar.gz} (analagous to \texttt{.zip}) package archive file. This package contains the source code for package functions. In RStudio, it can be installed by navigating to \texttt{Tools} \verb|->| \texttt{Install Packages...} \verb|->| \texttt{Install from:} \verb|->| \texttt{Package Archive File}. Computers running the Windows operating system can only install binary \texttt{.zip} package archive files unless they have additional compiler software installed. The \texttt{dbhydroR} binary package can be installed by running the following commands from the \texttt{R} console:

\vspace{10pt}
\noindent\texttt{install.packages(c("httr","RCurl","reshape2","XML"))}\\
\noindent\texttt{install.packages(paste(}\verb|"\\\\ad.sfwmd.gov\\DFSRoot\\data\\restoration_sciences",|\\
\verb|"\\projects\\joe_stachelek\\R\\dbhydroR_0.1-3.zip",sep="")|\\
\texttt{,type="win.binary",repos=NULL)}

\vspace{8pt}

Once installed, the package can be loaded using the following command:



\begin{Schunk}
\begin{Sinput}
> library(dbhydroR)
\end{Sinput}
\end{Schunk}



\section{Composing database queries}
\subsection{Water quality data}

The workhorse \texttt{dbhydroR} functions are \verb|getwq| and \texttt{gethydro}. The \texttt{getwq} function takes four required arguments. The user must specify a station ID, a test name, and a date range. Station IDs can be located on the \href{http://my.sfwmd.gov/KMLEXT/CUSTOMKMLS/DBHydro/DBHydroKML/DBHYDRO_KML.kmz}{SFWMD Google Earth portal}. A list of available test names can be found in the \nameref{sec:appendix} to this document. Dates must be specified in YYYY-MM-DD format (e.g. 2015-02-26).   The following set of examples retrieve measurements between March 2011 and May 2012. They can be run from the R console by issuing the command:

\begin{Schunk}
\begin{Sinput}
> example(getwq)
\end{Sinput}
\end{Schunk}

\begin{itemize}
\item One variable at one station

\begin{Schunk}
\begin{Sinput}
> getwq(station_id="FLAB08", date_min="2011-03-01",
+             date_max="2012-05-01",test_name="CHLOROPHYLLA-SALINE")
\end{Sinput}
\end{Schunk}

\item One variable at multiple stations

\begin{Schunk}
\begin{Sinput}
> getwq(station_id=c("FLAB08","FLAB09"), date_min="2011-03-01",
+             date_max="2012-05-01",test_name="CHLOROPHYLLA-SALINE")
\end{Sinput}
\end{Schunk}

\item One variable at a wildcard station

\begin{Schunk}
\begin{Sinput}
> getwq(station_id=c("FLAB0%"), date_min="2011-03-01",
+             date_max="2012-05-01",test_name="CHLOROPHYLLA-SALINE")
\end{Sinput}
\end{Schunk}

\item Multiple variables at multiple stations

\begin{Schunk}
\begin{Sinput}
> getwq(station_id=c("FLAB08","FLAB09"), date_min="2011-03-01",
+             date_max="2012-05-01",test_name=c("CHLOROPHYLLA-SALINE",
+                                               "SALINITY"))
\end{Sinput}
\end{Schunk}

\end{itemize}

\noindent By default, \verb|getwq| returns a "cleaned output". First, the cleaning function \verb|cleanwq| converts the raw output from native DBHYDRO "long" format (each piece of data on its own row) to "wide" format (each site x variable combination in its own column) using the reshape2 package \citep{reshape2}. Next, the QA blanks/flags and DBHydro database identifiers are stripped. Setting the \texttt{raw} flag to \texttt{TRUE} will force \verb|getwq| to retain this information. An example query that retains this information is shown below.

\begin{Schunk}
\begin{Sinput}
> getwq(station_id="FLAB08", date_min="2011-03-01",
+             date_max="2011-05-01",test_name="CHLOROPHYLLA-SALINE",
+             raw=TRUE)
\end{Sinput}
\end{Schunk}

\subsection{Hydrologic data}

Hydrologic time series data can be retrieved using the \texttt{gethydro} function either by specifying a set of known \texttt{dbkeys} or by retrieving \texttt{dbkeys} on-the-fly with entries in the Station ID (stationid), data category (category), and parameter (param) fields.\\

Complex stationid/category/parameter combinations can easily cause errors or return unexpected results. If dbkeys are not known ahead of time (or manually retrieved from the \href{http://my.sfwmd.gov/dbhydroplsql/show_dbkey_info.main_menu}{DBHYDRO Browser}, it is good practice to plug in your stationid/category/parameter combination to the \texttt{getdbkey} function to ensure that the listing looks reasonable. The following set of examples can be run from the R console by issuing the command:

\begin{Schunk}
\begin{Sinput}
> example(getdbkey)
\end{Sinput}
\end{Schunk}

\begin{itemize}
\item Complete specification of the Station ID, Category, and Parameter flags

\begin{Schunk}
\begin{Sinput}
> getdbkey(stationid="JBTS",category="WEATHER",param="WNDS")
\end{Sinput}
\end{Schunk}

\item Wildcard Station ID with no parameter specification

\begin{Schunk}
\begin{Sinput}
> getdbkey(stationid="C111%",category="SW")
> getdbkey(stationid="C111%",category="GW")
> getdbkey(stationid="C111%",category="WQ")
\end{Sinput}
\end{Schunk}

\item Returning only dbkeys with the blind flag

\begin{Schunk}
\begin{Sinput}
> getdbkey(stationid="JBTS",category="WEATHER",param="WNDS", blind=TRUE)
\end{Sinput}
\end{Schunk}

\end{itemize}


 In addition to a dbkey, users must specify a date range. Dates must be entered in YYYY-MM-DD format (e.g. 2015-02-26).   The following set of examples retrieve wind speed measurements between January and February 2013. They can be run from the R console by issuing the command:

\begin{Schunk}
\begin{Sinput}
> example(gethydro)
\end{Sinput}
\end{Schunk}

\begin{itemize}
\item One variable/station time series
\begin{Schunk}
\begin{Sinput}
> gethydro(dbkey="15081",
+          date_min="2013-01-01",date_max="2013-02-02")
\end{Sinput}
\end{Schunk}

\item Multiple variable/station time series
\begin{Schunk}
\begin{Sinput}
> gethydro(dbkey=c("15081","15069"),
+          date_min="2013-01-01",date_max="2013-02-02")
\end{Sinput}
\end{Schunk}

\item Retreiving unknown \texttt{dbkeys} on-the-fly

\begin{Schunk}
\begin{Sinput}
> gethydro(stationid="JBTS",category="WEATHER",
+          param="WNDS",date_min="2013-01-01",date_max="2013-02-02")
\end{Sinput}
\end{Schunk}

\end{itemize}

\section{\label{sec:appendix}Appendix}
\subsection{Test names}
There are many test names available in DBHYDRO. These are detailed in the following table.\\

\begin{longtable}{| p{.45\textwidth} | p{.55\textwidth} |} 
\hline
Code\\
\hline
AMMONIA-N\\
CARBON, TOTAL ORGANIC\\
CHLOROPHYLL-A(LC)\\
CHLOROPHYLL-B(LC)\\
CHLOROPHYLLA-SALINE\\
DISSOLVED OXYGEN\\
KJELDAHL NITROGEN,TOTAL\\
NITRATE+NITRITE-N\\
NITRITE-N\\
PHEOPHYTIN-A(LC)\\
PHOSPHATE,ORTHO AS P\\
PHOSPHATE,TOTAL AS P\\
SALINITY\\
SILICA\\
SP CONDUCTIVITY, FIELD\\
TEMP\\
TOTAL NITROGEN\\
TURBIDITY\\
\hline
\end{longtable}
%\end{tabular}

\subsection{Further reading}
See section on URL-based data access in the \href{http://www.sfwmd.gov/portal/page/portal/xrepository/sfwmd_repository_pdf/dbhydrobrowseruserdocumentation.pdf}{DBHYDRO Browser User's Guide}

\medskip
 
 %\setlength{\bibsep}{0pt}
\bibliography{bib}

 
\end{document}
